---
title: "Descriptive_Statistics"
author: "Jake Lieberfarb"
date: "3/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, results = T, message = T)
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
```



```{r Load 2015 data}
loadPkg('dplyr')
loadPkg('readxl')

#Read in general census data
census_2015 <- read.csv(file = 'acs2015updated.csv')

#Read in Specifically Education Data
edu_data_2015 <- read.csv("ACS_15_5YR_B15003_renamed.csv", skip = 1) %>% mutate(Id2 = as.numeric(Id2))

#Read in Freedom Data
freedom <- read_excel("Freedom_In_The_50_States_2018.xlsx", sheet = "Overall")

#Combine
census_edu_2015 <- left_join(census_2015, edu_data_2015, by = c("CensusTract" = "Id2"))
full_2015 <- full_join(census_edu_2015, freedom %>% filter(Year == 2015), by = "State") 

#For the education data, we will need to divide the count by the total
full_2015_eduProp <- full_2015 %>% mutate(PropHighSchool = EstHighSchool/EstTotal,
                                          PropBachelors = EstBachelors/EstTotal,
                                          PropDoctorate = EstDoctorate/EstTotal)
```

```{r Load 2017 data}
#Read in general census data
census_2017 <- read.csv(file = 'acs2017_census_tract_data.csv') %>% mutate(CensusTract = TractId, TractId = NULL) %>% left_join(census_2015 %>% select(INTPTLAT, INTPTLONG, GEOID, CensusTract), by = 'CensusTract')

#Read in Specifically Education Data
```


```{r Load 2017 data}
edu_data_2017 <- read.csv("ACS_17_5YR_B15003_renamed.csv", skip = 1) %>% mutate(Id2 = as.numeric(Id2))

#Read in Freedom Data
freedom <- read_excel("Freedom_In_The_50_States_2018.xlsx", sheet = "Overall")

#Combine
census_edu_2017 <- left_join(census_2017, edu_data_2017, by = c("CensusTract" = "Id2"))

full_2017 <- full_join(census_edu_2017, freedom %>% filter(Year == 2015), by = "State")

#For the education data, we will need to divide the count by the total
full_2017_eduProp <- full_2017 %>% mutate(PropHighSchool = EstHighSchool/EstTotal,
                                          PropBachelors = EstBachelors/EstTotal,
                                          PropDoctorate = EstDoctorate/EstTotal)
str(full_2017IPC)
```



```{r Remove Outliers}

# Fix outliers
outlierKD2 <- function(df, var, rm=FALSE) { 
    #' Original outlierKD functino by By Klodian Dhana,
    #' https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
    #' Modified to have third argument for removing outliers inwtead of interactive prompt, 
    #' and after removing outlier, original df will not be changed. The function returns the new df, 
    #' which can be saved as original df name if desired.
    #' Check outliers, and option to remove them, save as a new dataframe. 
    #' @param df The dataframe.
    #' @param var The variable in the dataframe to be checked for outliers
    #' @param rm Boolean. Whether to remove outliers or not.
    #' @return The dataframe with outliers replaced by NA if rm==TRUE, or df if nothing changed
    #' @examples
    #' outlierKD2(mydf, height, FALSE)
    #' mydf = outlierKD2(mydf, height, TRUE)
    #' mydfnew = outlierKD2(mydf, height, TRUE)
    dt = df # duplicate the dataframe for potential alteration
    var_name <- eval(substitute(var),eval(dt))
    na1 <- sum(is.na(var_name))
    m1 <- mean(var_name, na.rm = T)
    par(mfrow=c(2, 2), oma=c(0,0,3,0))
    boxplot(var_name, main="With outliers")
    hist(var_name, main="With outliers", xlab=NA, ylab=NA)
    outlier <- boxplot.stats(var_name)$out
    mo <- mean(outlier)
    var_name <- ifelse(var_name %in% outlier, NA, var_name)
    boxplot(var_name, main="Without outliers")
    hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
    title("Outlier Check", outer=TRUE)
    na2 <- sum(is.na(var_name))
    cat("Outliers identified:", na2 - na1, "\n")
    cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "\n")
    cat("Mean of the outliers:", round(mo, 2), "\n")
    m2 <- mean(var_name, na.rm = T)
    cat("Mean without removing outliers:", round(m1, 2), "\n")
    cat("Mean if we remove outliers:", round(m2, 2), "\n")
    
    # response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ")
    # if(response == "y" | response == "yes"){
    if(rm){
        dt[as.character(substitute(var))] <- invisible(var_name)
        #assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
        cat("Outliers successfully removed", "\n")
        return(invisible(dt))
    } else {
        cat("Nothing changed", "\n")
        return(invisible(df))
    }
}

```

```{r income}
loadPkg("ggplot2")

# NA's
sum(is.na(full_2017IPC$IncomePerCap))

#Length
length(full_2017IPC$IncomePerCap)


#Histogram of dependent variable
hist(full_2017IPC$IncomePerCap, 
        col = "#a8c2fb",
        main = "Income per Capita",
        xlab = "US Dollars")

#ggplot
qqnorm(full_2017IPC$IncomePerCap, main="Q-Q plot of IncomePerCap")
qqline(full_2017IPC$IncomePerCap)

#Mean after removing NA's
format(mean(full_2017IPC$IncomePerCap, na.rm = TRUE))

#Summary after removing NA's
summary(full_2017IPC$IncomePerCap)

```

```{r variables}
# do not use outliers for 
full_2017IPC <- outlierKD2(full_2017IPC, EconomicFreedom, TRUE) %>% outlierKD2(PersonalFreedom, TRUE) 
full_2017IPC <- outlierKD2(full_2017IPC, RegulatoryPolicy, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, FiscalPolicy, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Black, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Hispanic, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Unemployment, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Professional, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Office, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Asian, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Service, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, OverallFreedom, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Construction, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Production, TRUE)
full_2017IPC <- outlierKD2(full_2017IPC, Native, TRUE)



```

```{r geo scatter}
full_2015_2 <- subset(full_2015, INTPTLONG > -150 & INTPTLONG < -50 & INTPTLAT > 24 & INTPTLAT < 50) 
full_2017_2 <- subset(full_2017, INTPTLONG > -150 & INTPTLONG < -50 & INTPTLAT > 24 & INTPTLAT < 50) 


loadPkg("ggplot2")
ggplot(full_2015_2, aes( x= INTPTLONG, y = INTPTLAT, color = Hispanic)) + 
  geom_point(size=0.005) + scale_color_gradient(low="orange", high="red") +
  labs (title="Scatter Plot: Spanish Ethnicity in 2015",
        x=" Latitude",
        y = "Longitude")

ggplot(full_2017_2, aes( x= INTPTLONG, y = INTPTLAT, color = Hispanic)) + 
  geom_point(size=0.005) + scale_color_gradient(low="orange", high="red") +
  labs (title="Scatter Plot: Spanish Ethnicity in 2017",
        x=" Latitude",
        y = "Longitude")

```

```{r income}
loadPkg("ggplot2")

# NA's
sum(is.na(full_2017IPC$IncomePerCap))

#Length
length(full_2017IPC$IncomePerCap)


#Histogram of dependent variable
hist(full_2017IPC$IncomePerCap, 
        col = "#a8c2fb",
        main = "Income per Capita",
        xlab = "US Dollars")

#ggplot
qqnorm(full_2017IPC$IncomePerCap, main="Q-Q plot of IncomePerCap")
qqline(full_2017IPC$IncomePerCap)

#Mean after removing NA's
format(mean(full_2017IPC$IncomePerCap, na.rm = TRUE))

#Summary after removing NA's
summary(full_2017IPC$IncomePerCap)

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
